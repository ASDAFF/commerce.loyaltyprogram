var firstLoad=!0;function returnFormatDate(e){return("0"+e.getDate()).slice(-2)+"."+("0"+(e.getMonth()+1)).slice(-2)+"."+e.getFullYear()}BX.ready(function(){var e=document.querySelector("form[name=bonus_filter]");function t(t){t.preventDefault(),e.type_transactions.value="COMMERCE_LOYAL_WRITEOFF_withdraw",e.querySelector("button[type=submit]").click()}function a(e){document.getElementById("write_off").style.display="block"}function r(e){form=this,e.preventDefault();let t=parseFloat(this.bonus.value),a=parseFloat(this.bonus.min),r=parseFloat(this.bonus.max);a>t?this.bonus.value=this.bonus.min:r<t&&(this.bonus.value=this.bonus.max),dataSend={writeoff_bonus:this.bonus.value,writeoff_requisite:this.id_req.value},this.currency&&this.currency.value&&(dataSend.writeoff_currency=this.currency.value),BX.ajax({url:"/bitrix/components/commerce/loyaltyprogram.account/ajax.php",data:dataSend,method:"POST",dataType:"json",timeout:30,async:!0,processData:!0,emulateOnload:!0,start:!0,cache:!1,onsuccess:function(e){let t=form.querySelector(".error");t&&BX.remove(t),e?location.reload():BX.prepend(BX.create("div",{attrs:{className:"error"},html:BX.message("sw24_loyaltyprogram.ERROR_WRITE_OFF")}),form)},onfailure:function(e){console.log(e)}})}function i(i,s){!function(){e=document.querySelector("form[name=bonus_filter]");for(var i=document.querySelectorAll("a.selectTime"),s=document.querySelector(".lpBonusAccount [name=from_date]"),n=document.querySelector(".lpBonusAccount [name=to_date]"),o=0;o<i.length;o++)BX.bind(i[o],"click",BX.proxy(l,i[o]));function l(){s.value=typeSelectPeriod[this.dataset.period].from,n.value=typeSelectPeriod[this.dataset.period].to}var u=document.querySelector("a.show_write_form");if(u){u.removeEventListener("click",a),u.addEventListener("click",a);let e=document.getElementById("write_off");e.removeEventListener("submit",r),e.addEventListener("submit",r)}var c=document.querySelector("a.writeoff_select");c&&(c.removeEventListener("click",t),c.addEventListener("click",t))}(),i||s||firstLoad||setTimeout(function(){let t=(e=document.querySelector("form[name=bonus_filter]")).getBoundingClientRect();window.scrollTo(0,t.y+window.pageYOffset)},400),firstLoad&&(firstLoad=!1)}i(),BX.addCustomEvent("onAjaxSuccess",i)});var dayWeek=0==(new Date).getDay()?6:(new Date).getDay()-1,quarterO=[0,0,0,1,1,1,2,2,2,3,3,3],cDate=returnFormatDate(new Date),typeSelectPeriod={today:{from:cDate,to:cDate},yesterday:{from:returnFormatDate(new Date(new Date-864e5)),to:returnFormatDate(new Date(new Date-864e5))},week:{from:returnFormatDate(new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()-dayWeek,0,0,0)),to:returnFormatDate(new Date((new Date).getFullYear(),(new Date).getMonth(),(new Date).getDate()-dayWeek+6,0,0,0))},month:{from:returnFormatDate(new Date((new Date).getFullYear(),(new Date).getMonth(),1,0,0,0)),to:returnFormatDate(new Date((new Date).getFullYear(),(new Date).getMonth()+1,0,0,0,0))},year:{from:returnFormatDate(new Date((new Date).getFullYear(),0,1,0,0,0)),to:returnFormatDate(new Date((new Date).getFullYear()+1,0,0,0,0,0))},quarter:{from:returnFormatDate(new Date((new Date).getFullYear(),quarterO[(new Date).getMonth()],1,0,0,0)),to:returnFormatDate(new Date((new Date).getFullYear(),quarterO[(new Date).getMonth()]+3,0,0,0,0))},all:{from:"",to:""}},managerRequisite={init:function(e){this.requisite_area=e.requisite_area,this.requisiteList=[],this.control={},this.control.addLink=this.requisite_area.querySelector("#addRequisite"),this.control.cancelLink=this.requisite_area.querySelector("#cancelAddRequisite"),this.control.TypeButtons=this.requisite_area.querySelectorAll("[name=type_req]"),this.control.AddButton=this.requisite_area.querySelector("#addRequisiteButton"),this.area={},this.area.addForm=this.requisite_area.querySelector("#add_area_form"),this.area.InfoBLock=this.requisite_area.querySelector(".info"),this.area.ReqList=this.requisite_area.querySelector(".list"),this.area.ReqListSelect=document.querySelector("#select_cart_area"),new BX.MaskedInput({mask:"9999-9999-9999-9999",input:this.area.addForm.querySelector("input[name=cart]"),placeholder:"_"}),new BX.MaskedInput({mask:"99999999999999999999",input:this.area.addForm.querySelector("input[name=invoice]"),placeholder:"_"}),new BX.MaskedInput({mask:"999999999",input:this.area.addForm.querySelector("input[name=bik]"),placeholder:"_"}),this.statuses={},this.statuses.addType="cart",e.requisites.length>0&&(this.requisiteList=e.requisites),this.setListRequisites(),this.setControlEvent()},setControlEvent:function(){this.control.addLink.addEventListener("click",function(e){managerRequisite.area.InfoBLock.innerHTML="",this.style.display="none",managerRequisite.control.cancelLink.style.display="",managerRequisite.area.addForm.style.display=""}),this.control.AddButton.addEventListener("click",function(e){managerRequisite.area.InfoBLock.innerHTML="",managerRequisite.area.InfoBLock.classList.remove("error","success"),"cart"==managerRequisite.statuses.addType&&""==managerRequisite.area.addForm.querySelector("input[name=cart]").value?(managerRequisite.area.InfoBLock.innerHTML=BX.message("sw24_loyaltyprogram.ERROR_EMPTY_CART"),managerRequisite.area.InfoBLock.classList.add("error")):"invoice"!=managerRequisite.statuses.addType||""!=managerRequisite.area.addForm.querySelector("input[name=bik]").value&&""!=managerRequisite.area.addForm.querySelector("input[name=invoice]").value?BX.ajax({url:"/bitrix/components/commerce/loyaltyprogram.account/ajax.php",data:{type:managerRequisite.statuses.addType,cart:managerRequisite.area.addForm.querySelector("input[name=cart]").value,invoice:managerRequisite.area.addForm.querySelector("input[name=invoice]").value,bik:managerRequisite.area.addForm.querySelector("input[name=bik]").value},method:"POST",dataType:"json",timeout:30,async:!0,processData:!0,emulateOnload:!0,start:!0,cache:!1,onsuccess:function(e){managerRequisite.area.InfoBLock.innerHTML="",managerRequisite.area.InfoBLock.classList.remove("error","success"),e?(managerRequisite.area.InfoBLock.innerHTML=BX.message("sw24_loyaltyprogram.REQUISITE_SUCCESS_ADD"),managerRequisite.area.InfoBLock.classList.add("success"),managerRequisite.area.addForm.style.display="none",managerRequisite.control.addLink.style.display="",managerRequisite.control.cancelLink.style.display="none",managerRequisite.getListRequisites(e.list)):(managerRequisite.area.InfoBLock.innerHTML=BX.message("sw24_loyaltyprogram.ERROR_SERVER"),managerRequisite.area.InfoBLock.classList.add("error"))},onfailure:function(e){console.log(e)}}):(managerRequisite.area.InfoBLock.innerHTML=BX.message("sw24_loyaltyprogram.ERROR_EMPTY_INVOICE"),managerRequisite.area.InfoBLock.classList.add("error"))}),this.control.cancelLink.addEventListener("click",function(e){this.style.display="none",managerRequisite.control.addLink.style.display="",managerRequisite.area.addForm.style.display="none"});for(let e of this.control.TypeButtons)e.addEventListener("change",function(e){managerRequisite.area.addForm.querySelector("input[name=cart]").closest("label").style.display="none",managerRequisite.area.addForm.querySelector("input[name=bik]").closest("label").style.display="none",managerRequisite.area.addForm.querySelector("input[name=invoice]").closest("label").style.display="none",managerRequisite.statuses.addType=this.value,"cart"==this.value?managerRequisite.area.addForm.querySelector("input[name=cart]").closest("label").style.display="":(managerRequisite.area.addForm.querySelector("input[name=bik]").closest("label").style.display="",managerRequisite.area.addForm.querySelector("input[name=invoice]").closest("label").style.display="")})},getListRequisites:function(e){e&&(this.requisiteList=e),this.setListRequisites()},setListRequisites:function(){if(this.area.ReqList.innerHTML="",this.area.ReqListSelect.innerHTML="",this.requisiteList.length>0){var e="",t="",a='<span class="success" style="display:none;">'+BX.message("sw24_loyaltyprogram.EDITED_REQUISITE")+'</span> <a href="javacript:void(0);" class="startEdit">'+BX.message("sw24_loyaltyprogram.EDIT_REQUISITE")+'</a> <button class="edit" style="display:none;" type="button">'+BX.message("sw24_loyaltyprogram.EDIT_REQUISITE")+'</button> <button class="delete" style="display:none;" type="button">'+BX.message("sw24_loyaltyprogram.DELETE_REQUISITE")+'</button> <button class="cancel" style="display:none;" type="button">'+BX.message("sw24_loyaltyprogram.CANCEL_ADD_REQUISITE")+"</button>";for(let i=0;i<this.requisiteList.length;i++){var r=this.requisiteList[i];let s=this.requisiteList.length-i==1?" checked":"",n=this.requisiteList.length-i==1?" selected":"",o='<input type="hidden" name="id_req1" value="'+r.id+'"'+s+">";"cart"==r.type?(e+="<tr><td>"+o+BX.message("sw24_loyaltyprogram.PAY_TYPE_CART")+'</td><td><input name="cart" type="text" value="'+r.cart+'" disabled></td><td>&nbsp;</td><td>&nbsp;</td><td>'+a+"</td></tr>",t+="<option "+n+' value="'+r.id+'">'+BX.message("sw24_loyaltyprogram.PAY_TYPE_CART")+": "+r.cart+"</option>"):(e+="<tr><td>"+o+BX.message("sw24_loyaltyprogram.PAY_TYPE_INVOICE")+'</td><td>&nbsp;</td><td><input name="invoice" type="text" value="'+r.invoice+'" disabled></td><td><input name="bik" type="text" value="'+r.bik+'" disabled></td><td>'+a+"</td></tr>",t+="<option "+n+' value="'+r.id+'">'+BX.message("sw24_loyaltyprogram.PAY_TYPE_INVOICE")+": "+r.invoice+"</option>")}this.area.ReqListSelect.innerHTML='<select name="id_req">'+t+"</select>",this.area.ReqList.innerHTML=e,this.setRequisiteManager();let i=this.area.ReqList.querySelectorAll("input[name=cart]");if(i.length>0)for(let e of i)new BX.MaskedInput({mask:"9999-9999-9999-9999",input:e,placeholder:"_"});let s=this.area.ReqList.querySelectorAll("input[name=invoice]");if(s.length>0)for(let e of s)new BX.MaskedInput({mask:"99999999999999999999",input:e,placeholder:"_"});let n=this.area.ReqList.querySelectorAll("input[name=bik]");if(n.length>0)for(let e of n)new BX.MaskedInput({mask:"999999999",input:e,placeholder:"_"});BX("write_off").querySelector("button[type=submit]").disabled=!1}else this.area.ReqListSelect.innerHTML+=' <div class="error">'+BX.message("sw24_loyaltyprogram.EMPTY_CARTLIST")+"</div>",BX("write_off").querySelector("button[type=submit]").disabled=!0;this.area.ReqListSelect.innerHTML+=' <a href="javascript:void(0);" id="open_edit_requisite">'+BX.message("sw24_loyaltyprogram.PAY_SETTING")+"</a>",this.setRequisiteListManager()},setRequisiteListManager:function(){let e=this.area.ReqListSelect.querySelector("#open_edit_requisite");e&&e.addEventListener("click",function(e){managerRequisite.requisite_area.style.display="none"==managerRequisite.requisite_area.style.display?"":"none"})},setRequisiteManager:function(){let e=this.area.ReqList.querySelectorAll(".startEdit");for(let t of e)t.addEventListener("click",function(e){let t=this.closest("tr"),a=t.querySelector("input[name=cart]"),r=t.querySelector(".success"),i=t.querySelector(".cancel"),s=t.querySelector(".delete"),n=t.querySelector(".edit");a?a.disabled=!1:(t.querySelector("input[name=invoice]").disabled=!1,t.querySelector("input[name=bik]").disabled=!1),r.style.display="none",n.style.display="",i.style.display="",s.style.display="",this.style.display="none"});let t=this.area.ReqList.querySelectorAll(".cancel");for(let e of t)e.addEventListener("click",function(e){let t=this.closest("tr"),a=t.querySelector("input[name=cart]"),r=t.querySelector(".success"),i=t.querySelector(".startEdit"),s=t.querySelector(".delete"),n=t.querySelector(".edit");a?a.disabled=!0:(t.querySelector("input[name=invoice]").disabled=!0,t.querySelector("input[name=bik]").disabled=!0),r.style.display="none",n.style.display="none",s.style.display="none",i.style.display="",this.style.display="none"});let a=this.area.ReqList.querySelectorAll(".edit");for(let e of a)e.addEventListener("click",function(e){let t=this.closest("tr"),a=t.querySelector("input[name=cart]"),r=t.querySelector(".success"),i=t.querySelector(".startEdit"),s=t.querySelector(".delete"),n=t.querySelector(".cancel");sendData={},sendData.type="updateRequisites",sendData.id=t.querySelector("input[name=id_req1]").value,a?(a.disabled=!0,sendData.cart=a.value):(t.querySelector("input[name=invoice]").disabled=!0,t.querySelector("input[name=bik]").disabled=!0,sendData.invoice=t.querySelector("input[name=invoice]").value,sendData.bik=t.querySelector("input[name=bik]").value),r.style.display="none",n.style.display="none",s.style.display="none",i.style.display="none",this.style.display="none",BX.ajax({url:"/bitrix/components/commerce/loyaltyprogram.account/ajax.php",data:sendData,method:"POST",dataType:"json",timeout:30,async:!0,processData:!0,emulateOnload:!0,start:!0,cache:!1,onsuccess:function(e){i.style.display="",e&&(r.style.display="",sendData.cart?managerRequisite.area.ReqListSelect.querySelector('option[value="'+sendData.id+'"]').innerHTML=BX.message("sw24_loyaltyprogram.PAY_TYPE_CART")+":"+sendData.cart:managerRequisite.area.ReqListSelect.querySelector('option[value="'+sendData.id+'"]').innerHTML=BX.message("sw24_loyaltyprogram.PAY_TYPE_INVOICE")+":"+sendData.invoice)},onfailure:function(e){console.log(e)}})});let r=this.area.ReqList.querySelectorAll(".delete");for(let e of r)e.addEventListener("click",function(e){let t=this.closest("tr"),a=(t.querySelector("input[name=cart]"),t.querySelector(".success")),r=t.querySelector(".startEdit"),i=t.querySelector(".delete"),s=t.querySelector(".cancel");sendData={},sendData.type="deleteRequisites",sendData.id=t.querySelector("input[name=id_req1]").value,a.style.display="none",s.style.display="none",i.style.display="none",r.style.display="none",this.style.display="none",BX.ajax({url:"/bitrix/components/commerce/loyaltyprogram.account/ajax.php",data:sendData,method:"POST",dataType:"json",timeout:30,async:!0,processData:!0,emulateOnload:!0,start:!0,cache:!1,onsuccess:function(e){r.style.display="",e&&(t.remove(),managerRequisite.area.ReqListSelect.querySelector('option[value="'+sendData.id+'"]').remove(),managerRequisite.getListRequisites(e.list))},onfailure:function(e){console.log(e)}})})}};