var commerceOrderAjaxBonus={init:function(e,s,a,o){this.bonuses={},this.blocks={},this.params={},this.bonuses.max=1*atob(e),this.bonuses.current=0,this.bonuses.currency=o,this.bonuses.added=0,this.bonuses.added_format="",this.bonuses.avialable=s,this.bonuses.avialable_format=a,this.getParamFromSOA(),this.getBonusAdded(),this.setEventPaginator(),this.blocks.payment=document.querySelector("#bx-soa-bonus-2").innerHTML,BX.addCustomEvent("onAjaxSuccess",function(e,s){e&&e.order&&s&&s.url&&("/bitrix/components/bitrix/sale.order.ajax/ajax.php"==s.url||"/local/components/bitrix/sale.order.ajax/ajax.php"==s.url)&&(commerceOrderAjaxBonus.getParamFromSOA(),commerceOrderAjaxBonus.getBonusAdded(),commerceOrderAjaxBonus.setEventPaginator())})},setEventPaginator:function(){if(this.soaForm){let e=document.querySelectorAll("#bx-soa-order-form .bx-soa-editstep, #bx-soa-order-form .pull-left, #bx-soa-order-form .pull-right");if(e.length>0)for(let s of e)s.addEventListener("click",function(){commerceOrderAjaxBonus.setPayBlock()})}else setTimeout(function(){commerceOrderAjaxBonus.setEventPaginator()},100)},getParamFromSOA:function(){if(BX.Sale.OrderAjaxComponent.result&&BX.Sale.OrderAjaxComponent.result.ORDER_PROP){var e=BX.Sale.OrderAjaxComponent.result.ORDER_PROP.properties;for(var s in void 0!==BX.Sale.OrderAjaxComponent.result.sw24_loyalty_max_bonus&&(this.bonuses.max=parseFloat(BX.Sale.OrderAjaxComponent.result.sw24_loyalty_max_bonus)),0==this.bonuses.max&&this.bonuses.current>0&&(this.bonuses.current=0),e)if("commerce_bonus"==e[s].CODE){this.soaForm=document.querySelector("#bx-soa-order-form"),this.params.bonusPayProp=e[s].ID,this.params.bonusPayPropInput=this.soaForm.querySelector("#soa-property-"+this.params.bonusPayProp),this.params.bonusPayPropInput||(this.params.bonusPayPropInput=BX.create("input",{attrs:{type:"hidden",value:this.bonuses.current,id:"soa-property-"+e[s].ID,name:"ORDER_PROP_"+e[s].ID}}),this.soaForm.appendChild(this.params.bonusPayPropInput)),this.params.bonusPayPropblock=this.soaForm.querySelector('[data-property-id-row="'+this.params.bonusPayProp+'"]'),this.params.bonusPayPropblock&&(commerceOrderAjaxBonus.params.bonusPayPropblock.style.display="none"),BX.Sale.OrderAjaxComponent.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY&&BX.Sale.OrderAjaxComponent.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY<this.bonuses.max&&(this.bonuses.max=BX.Sale.OrderAjaxComponent.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY),this.setPayBlock();break}}else setTimeout(function(){commerceOrderAjaxBonus.getParamFromSOA()},100)},getBonusAdded:function(){BX.ajax({url:"/bitrix/components/commerce/order.ajax.bonus2/ajax.php",data:{type:"bonus_added",payed:this.bonuses.current},method:"POST",dataType:"json",timeout:30,async:!0,processData:!0,scriptsRunFirst:!0,emulateOnload:!0,start:!0,cache:!1,onsuccess:function(e){e.bonus?(commerceOrderAjaxBonus.bonuses.added=e.bonus,commerceOrderAjaxBonus.bonuses.added_format=e.bonus_format):(commerceOrderAjaxBonus.bonuses.added&&delete commerceOrderAjaxBonus.bonuses.added,commerceOrderAjaxBonus.bonuses.added_format&&delete commerceOrderAjaxBonus.bonuses.added_format),commerceOrderAjaxBonus.setTotalblock()},onfailure:function(e){}})},setPayBlock:function(){setTimeout(function(){let e=commerceOrderAjaxBonus.soaForm.querySelector("#bx-soa-paysystem .bx-soa-pp-desc-container .bx-soa-pp-company");if(e&&commerceOrderAjaxBonus.bonuses.max>0&&!BX("pay_loyalty_bonus")){let s=commerceOrderAjaxBonus.blocks.payment.replace("#MAX_BONUS#",commerceOrderAjaxBonus.bonuses.max).replace("#CURRENT_BONUS#",commerceOrderAjaxBonus.bonuses.current).replace("#ALL_BONUS#",commerceOrderAjaxBonus.bonuses.avialable_format).replace("#MAX_BONUS_FORMAT#",BX.Currency.currencyFormat(commerceOrderAjaxBonus.bonuses.max,commerceOrderAjaxBonus.bonuses.currency,!0));e.insertBefore(BX.create("div",{attrs:{id:"pay_loyalty_bonus"},html:s}),e.firstChild),commerceOrderAjaxBonus.params.bonusInput=BX("pay_loyalty_bonus").querySelector("input[type=number]"),commerceOrderAjaxBonus.setTotalblock(),commerceOrderAjaxBonus.params.bonusInput.addEventListener("change",function(){commerceOrderAjaxBonus.changePayBonus()}),commerceOrderAjaxBonus.params.bonusInput.addEventListener("click",function(e){return e.stopPropagation(),!1})}},200)},setTotalblock:function(){if(this.soaForm){let e=this.soaForm.querySelector("#bx-soa-total .bx-soa-cart-total");if(e){let s=e.querySelector(".bx-soa-cart-total-line-total");if(this.bonuses.added>0){let a=e.querySelector("#loyalty_added");a||(a=BX.create("div",{attrs:{id:"loyalty_added",className:"bx-soa-cart-total-line"},html:" "}),e.insertBefore(a,s)),a.innerHTML='<span class="bx-soa-cart-t">'+BX.message("hasbonusAdded")+'</span><span class="bx-soa-cart-d">~'+this.bonuses.added_format+"</span>"}else BX("loyalty_added")&&BX("loyalty_added").remove();if(this.bonuses.current>0){let a=e.querySelector("#loyalty_payed");a||(a=BX.create("div",{attrs:{id:"loyalty_payed",className:"bx-soa-cart-total-line"},html:" "}),e.insertBefore(a,s)),a.innerHTML='<span class="bx-soa-cart-t">'+BX.message("bonus_pay_total")+'</span><span class="bx-soa-cart-d">'+BX.Currency.currencyFormat(this.bonuses.current,this.bonuses.currency,!0)+"</span>"}else BX("loyalty_payed")&&BX("loyalty_payed").remove();let a=BX.Sale.OrderAjaxComponent.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY?BX.Sale.OrderAjaxComponent.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY:BX.Sale.OrderAjaxComponent.result.TOTAL.ORDER_TOTAL_PRICE;a-=this.bonuses.current,s.querySelector(".bx-soa-cart-d").innerHTML=BX.Currency.currencyFormat(a,this.bonuses.currency,!0)}let s=this.soaForm.querySelector("#bx-soa-total-mobile .bx-soa-cart-total");if(s){let e=s.querySelector(".bx-soa-cart-total-line-total");if(this.bonuses.added>0){let a=s.querySelector("#loyalty_added2");a||(a=BX.create("div",{attrs:{id:"loyalty_added2",className:"bx-soa-cart-total-line"},html:" "}),s.insertBefore(a,e)),a.innerHTML='<span class="bx-soa-cart-t">'+BX.message("hasbonusAdded")+'</span><span class="bx-soa-cart-d">~'+this.bonuses.added_format+"</span>"}else BX("loyalty_added2")&&BX("loyalty_added2").remove();if(this.bonuses.current>0){let a=s.querySelector("#loyalty_payed2");a||(a=BX.create("div",{attrs:{id:"loyalty_payed2",className:"bx-soa-cart-total-line"},html:" "}),s.insertBefore(a,e)),a.innerHTML='<span class="bx-soa-cart-t">'+BX.message("bonus_pay_total")+'</span><span class="bx-soa-cart-d">'+BX.Currency.currencyFormat(this.bonuses.current,this.bonuses.currency,!0)+"</span>"}else BX("loyalty_payed2")&&BX("loyalty_payed2").remove();let a=BX.Sale.OrderAjaxComponent.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY?BX.Sale.OrderAjaxComponent.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY:BX.Sale.OrderAjaxComponent.result.TOTAL.ORDER_TOTAL_PRICE;a-=this.bonuses.current,e.querySelector(".bx-soa-cart-d").innerHTML=BX.Currency.currencyFormat(a,this.bonuses.currency,!0)}}},changePayBonus:function(){(this.params.bonusInput.value.indexOf(".")>-1||this.params.bonusInput.value.indexOf(",")>-1)&&(this.params.bonusInput.step=".01"),this.params.bonusInput.value>this.bonuses.max&&(this.params.bonusInput.value=this.bonuses.max),this.bonuses.current=this.params.bonusInput.value,this.params.bonusPayPropInput.value=this.bonuses.current,this.reloadTotalblock()},reloadTotalblock:function(){this.reloadTimeTotalBlock&&clearTimeout(this.reloadTimeTotalBlock),this.reloadTimeTotalBlock=setTimeout(function(){commerceOrderAjaxBonus.getBonusAdded()},500)}};