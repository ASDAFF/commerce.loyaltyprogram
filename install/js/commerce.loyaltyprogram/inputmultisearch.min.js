BX.ready(function(){"use strict";BX.namespace("InputMultiSearch"),BX.InputMultiSearch=function(t){this._state={dropdown:[],storage:[...t.storage]},this.options={url:t.url?t.url:location.href,inputName:t.inputName?t.inputName:"prop_filter",delay:350},this.c_main=document.querySelector(".sw24-input-multi-search"),this.c_storage=this.c_main.querySelector(".storage .storage_wrapper"),this.c_search=this.c_main.querySelector(".search .search_input"),this.c_dropdown=this.c_main.querySelector(".search_dropdown"),this._init()},BX.InputMultiSearch.prototype={_init:function(){this._render(),this._onEvents()},_render:function(){this._handleDropDownRender(),this._handleStorageRender()},_handleDropDownRender:function(){if(this.c_dropdown.innerHTML="",this._state.dropdown.length>0)for(let t of this._state.dropdown){let e=[];for(let a of t.props)e.push(BX.create({tag:"div",attrs:{className:"search_dropdown_item"+(this._isHasPropStorage(a.id)?" _disabled":""),"data-id":a.id,"data-name":a.name,"data-iblock-id":t.id,"data-iblock-name":t.name},text:a.name+" ["+a.id+"]",events:{click:this._action.bind(this,this._handleStorageAdd)}}));this.c_dropdown.append(BX.create({tag:"div",attrs:{className:"search_dropdown_group"},children:[BX.create({tag:"div",attrs:{className:"search_dropdown_group_name"},text:t.name+" ["+t.id+"]"}),BX.create({tag:"div",attrs:{className:"search_dropdown_group_list"},children:e})]}))}else this.c_dropdown.append(BX.create({tag:"div",attrs:{className:"search_dropdown_empty"},text:"Empty search...."}))},_handleStorageRender:function(){if(!this._state.storage)return!1;this.c_storage.innerHTML="";for(let t of this._state.storage){let e=BX.create({tag:"div",attrs:{className:"storage_item","data-id":t.id},children:[BX.create({tag:"input",props:{value:t.id,name:this.options.inputName+"[]"},attrs:{type:"hidden"}}),BX.create({tag:"div",attrs:{className:"item_name",title:this._formatName("title",t.name,{iblockId:t.iblockId,iblockName:t.iblockName,id:t.id})},text:this._formatName("text",t.name,{id:t.id})}),BX.create({tag:"div",attrs:{className:"item_delete"},html:'<i class="fa fa-times"></i>',events:{click:this._action.bind(this,this._handleStorageRemove)}})]});this.c_storage.append(e)}},_handleStorageRemove:function(t){let e=BX.findParent(t.target,{class:"storage_item"});this._storageRemove(e.dataset.id)},_handleStorageAdd:async function(t){let e=t.target.dataset.id,a=t.target.dataset.name,i=t.target.dataset.iblockId;this._isHasPropStorage(e)?this._storageRemove(e):this._storageAdd({id:e,iblockId:i,iblockName:t.target.dataset.iblockName,name:a})},_handleInput:async function(t){if(!t)return;let e=this;return new Promise(function(a,i){e._state.timeout&&clearTimeout(e._state.timeout),e._state.timeout=setTimeout(()=>{let i={value:t,storage:e._state.storage,type:"getPropList",ajax:"y"};e._request(i).then(t=>a(e._setDropdown(t)))},e.options.delay)})},_setDropdown(t){let e=[];if("object"==typeof t)for(let a in t)e.push(t[a]);this._state.dropdown=e},_storageAdd:function(t){this._state.storage.push(t)},_storageRemove:function(t){for(let e=0;e<this._state.storage.length;e++)this._state.storage[e].id==t&&this._state.storage.splice(e,1)},_isHasPropStorage:function(t){return this._state.storage.find(function(e){if(e.id==t)return!0})},_action:async function(t,e){this.c_search.classList.add("_load"),await t.bind(this,e)(),this._render(),this.c_search.classList.remove("_load")},_formatName:function(t="text",e,a){return"title"==t?"["+a.iblockId+" - "+a.iblockName+"] "+e+"("+a.id+")":e&&0!=e.length?e.length>10?e?e.slice(0,10)+"... ["+a.id+"]":a.id:e+" ["+a.id+"]":a.id},_request:function(t){let e=this;return new Promise(function(a,i){BX.ajax({url:e.options.url,data:t,method:"POST",onsuccess:function(t){a(BX.parseJSON(t))}})})},_onEvents:function(){let t=this;this.c_search.querySelector("input").addEventListener("input",function(){t._action.call(t,t._handleInput,this.value)})}}});