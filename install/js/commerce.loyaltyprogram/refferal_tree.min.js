function setReferraltree(t){var e,n=0,r=null,a=null,l=200,i=0,o=750,s=($("#tree-container"),$("#tree-container").width()),c=$(document).height(),d=d3.layout.tree().size([c,s]),u=d3.svg.diagonal().projection(function(t){return[t.y,t.x]});function h(){d.sort(function(t,e){return e.name.toLowerCase()<t.name.toLowerCase()?1:-1})}function f(t,e){var n=l;panTimer&&(clearTimeout(panTimer),translateCoords=d3.transform(E.attr("transform")),"left"==e||"right"==e?(translateX="left"==e?translateCoords.translate[0]+n:translateCoords.translate[0]-n,translateY=translateCoords.translate[1]):"up"!=e&&"down"!=e||(translateX=translateCoords.translate[0],translateY="up"==e?translateCoords.translate[1]+n:translateCoords.translate[1]-n),scaleX=translateCoords.scale[0],scaleY=translateCoords.scale[1],scale=g.scale(),E.transition().attr("transform","translate("+translateX+","+translateY+")scale("+scale+")"),d3.select(t).select("g.node").attr("transform","translate("+translateX+","+translateY+")"),g.scale(g.scale()),g.translate([translateX,translateY]),panTimer=setTimeout(function(){f(t,n)},50))}!function t(e,n,r){if(e){n(e);var a=r(e);if(a)for(var l=a.length,i=0;i<l;i++)t(a[i],n,r)}}(t,function(t){0,n=Math.max(t.name.length,n)},function(t){return t.children&&t.children.length>0?t.children:null}),h();var g=d3.behavior.zoom().scaleExtent([.1,3]).on("zoom",function(){E.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")")});var v=d3.select("#tree-container").append("svg").attr("width",s).attr("height",c).attr("class","overlay").call(g);function p(){r=null,d3.selectAll(".ghostCircle").attr("class","ghostCircle"),d3.select(domNode).attr("class","node"),d3.select(domNode).select(".ghostCircle").attr("pointer-events",""),k(),null!==a&&(w(e),T(a),a=null)}function m(t){t._children&&(t.children=t._children,t.children.forEach(m),t._children=null)}dragListener=d3.behavior.drag().on("dragstart",function(t){t!=e&&(dragStarted=!0,nodes=d.nodes(t),d3.event.sourceEvent.stopPropagation())}).on("drag",function(t){if(t!=e){if(dragStarted&&(domNode=this,function(t,e){a=t,d3.select(e).select(".ghostCircle").attr("pointer-events","none"),d3.selectAll(".ghostCircle").attr("class","ghostCircle show"),d3.select(e).attr("class","node activeDrag"),E.selectAll("g.node").sort(function(t,e){return t.id!=a.id?1:-1}),nodes.length>1&&(links=d.links(nodes),nodePaths=E.selectAll("path.link").data(links,function(t){return t.target.id}).remove(),nodesExit=E.selectAll("g.node").data(nodes,function(t){return t.id}).filter(function(t,e){return t.id!=a.id}).remove()),parentLink=d.links(d.nodes(a.parent)),E.selectAll("path.link").filter(function(t,e){return t.target.id==a.id}).remove(),dragStarted=null}(t,domNode)),relCoords=d3.mouse($("svg").get(0)),relCoords[0]<20)panTimer=!0,f(this,"left");else if(relCoords[0]>$("svg").width()-20)panTimer=!0,f(this,"right");else if(relCoords[1]<20)panTimer=!0,f(this,"up");else if(relCoords[1]>$("svg").height()-20)panTimer=!0,f(this,"down");else try{clearTimeout(panTimer)}catch(t){}t.x0+=d3.event.dy,t.y0+=d3.event.dx,d3.select(this).attr("transform","translate("+t.y0+","+t.x0+")"),k()}}).on("dragend",function(t){if(t!=e)if(domNode=this,r){var n=a.parent.children.indexOf(a);n>-1&&a.parent.children.splice(n,1),void 0!==r.children||void 0!==r._children?void 0!==r.children?r.children.push(a):r._children.push(a):(r.children=[],r.children.push(a)),m(r),h(),p()}else p()});var C=function(t){r=t,k()},_=function(t){r=null,k()},k=function(){var t=[];null!==a&&null!==r&&(t=[{source:{x:r.y0,y:r.x0},target:{x:a.y0,y:a.x0}}]);var e=E.selectAll(".templink").data(t);e.enter().append("path").attr("class","templink").attr("d",d3.svg.diagonal()).attr("pointer-events","none"),e.attr("d",d3.svg.diagonal()),e.exit().remove()};function T(t){scale=g.scale(),x=-t.y0,y=-t.x0,x=150,y=y*scale+c/2,d3.select("g").transition().duration(o).attr("transform","translate("+x+","+y+")scale("+scale+")"),g.scale(scale),g.translate([x,y])}function A(t){d3.event.defaultPrevented||(w(t=function(t){return t.children?(t._children=t.children,t.children=null):t._children&&(t.children=t._children,t._children=null),t}(t)),T(t))}function w(t){var r=[1],a=function(t,e){e.children&&e.children.length>0&&(r.length<=t+1&&r.push(0),r[t+1]+=e.children.length,e.children.forEach(function(e){a(t+1,e)}))};a(0,e);var l=25*d3.max(r),c=(d=d.size([l,s])).nodes(e).reverse(),h=d.links(c);c.forEach(function(t){t.y=t.depth*(10*n)}),node=E.selectAll("g.node").data(c,function(t){return t.id||(t.id=++i)});var f=node.enter().append("g").attr("class","node").attr("transform",function(e){return"translate("+t.y0+","+t.x0+")"}).on("click",A);f.append("circle").attr("class",function(t){return"nodeCircle level"+t.level}).attr("r",0).style("fill",function(t){return t._children?"lightsteelblue":"#fff"}),f.append("text").attr("x",function(t){return t.children||t._children?-10:10}).attr("dy",".35em").attr("class","nodeText").attr("text-anchor",function(t){return t.children||t._children?"end":"start"}).text(function(t){return t.name}).style("fill-opacity",0),f.append("circle").attr("class","ghostCircle").attr("r",30).attr("opacity",.2).style("fill","red").attr("pointer-events","mouseover").on("mouseover",function(t){C(t)}).on("mouseout",function(t){_(t)}),node.select("text").attr("x",function(t){return t.children||t._children?-10:10}).attr("text-anchor",function(t){return t.children||t._children?"end":"start"}).text(function(t){return t.name}),node.select("circle.nodeCircle").attr("r",4.5).style("fill",function(t){return t._children?"lightsteelblue":"#fff"}),node.transition().duration(o).attr("transform",function(t){return"translate("+t.y+","+t.x+")"}).select("text").style("fill-opacity",1);var g=node.exit().transition().duration(o).attr("transform",function(e){return"translate("+t.y+","+t.x+")"}).remove();g.select("circle").attr("r",0),g.select("text").style("fill-opacity",0);var v=E.selectAll("path.link").data(h,function(t){return t.target.id});v.enter().insert("path","g").attr("class","link").attr("d",function(e){var n={x:t.x0,y:t.y0};return u({source:n,target:n})}),v.transition().duration(o).attr("d",u),v.exit().transition().duration(o).attr("d",function(e){var n={x:t.x,y:t.y};return u({source:n,target:n})}).remove(),c.forEach(function(t){t.x0=t.x,t.y0=t.y})}var E=v.append("g");(e=t).x0=10,e.y0=0,w(e),T(e),setTimeout(function(){gRect=$("#tree-container svg").children().get(0).getBoundingClientRect();var t=gRect.height+40;(t=t>1e3?1e3:t)<c&&(c=t,v.attr("height",t),$("#tree-container svg").height(t),w(e),T(e))},800)}