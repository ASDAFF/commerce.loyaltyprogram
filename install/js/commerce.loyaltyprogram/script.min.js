var loyaltyTools={setHint:function(){for(var e=document.querySelectorAll(".skwb24-item-hint"),t=0;t<e.length;t++){var n=e[t];n.dataset.hint&&new top.BX.CHint({parent:n,show_timeout:10,hide_timeout:200,dx:2,preventHide:!0,min_width:400,hint:n.dataset.hint})}},checkUser:function(e,t){var n="notExists";return BX.ajax({url:"/bitrix/admin/commerce_loyaltyprogram_referrals.php?lang=ru",data:{ajax:"y",userId:e},method:"POST",dataType:"json",timeout:300,async:!1,onsuccess:function(i){i&&1==i.existStatus&&(n="isExists",t&&BX.ajax({url:"/bitrix/admin/commerce_loyaltyprogram_referrals.php?lang=ru",data:{ajax:"y",userId:e,modifier:t},method:"POST",dataType:"json",timeout:300,async:!1,onsuccess:function(e){e&&e.existStatus&&(n=e.existStatus)},onfailure:function(e){console.log(e)}}))},onfailure:function(e){console.log(e)}}),n}},manageCondTree={init:function(e){for(key in this.rootNode=e.rootNode,this.showControls=e.showControls,this.condDescriptions=[],this.conditionRulesSet=[{code:"allow_bonus_max",type:"SELECT",left:0,right:3,showVal:["Y","F"]},{code:"through_time",type:"SELECT",left:0,right:3,showVal:"Y"},{code:"limit_time",type:"SELECT",left:0,right:3,showVal:"Y"},{code:"before_date",type:"SELECT",left:0,right:3,showVal:["Y","A"]}],this.showControls)if(this.showControls[key].children)for(keyChildren in this.showControls[key].children){var t=this.showControls[key].children[keyChildren];t.description&&(this.condDescriptions[t.controlId]=t.description)}setTimeout(function(){manageCondTree.updateView()},300),setTimeout(function(){manageCondTree.setActionMarker()},300)},setActionMarker:function(){let e=document.querySelectorAll('a[id*="number_action_link"]');for(let t of e)letParentWrapper=t.closest(".condition-container"),letParentWrapper&&t.innerHTML>0&&BX.insertAfter(BX.create("span",{attrs:{className:"actionLabel"},text:"#"+t.innerHTML}),letParentWrapper)},setVisibleTree:function(){let e="none";if(e=Array.isArray(this.conditionAnimate.showVal)?this.conditionAnimate.showVal.includes(this.value)?"inline-block":"none":this.value==this.conditionAnimate.showVal?"inline-block":"none",this.conditionAnimate&&this.conditionAnimate.left>0)for(var t=0,n=this;t<=this.conditionAnimate.left;)"SPAN"!=(n=n.previousElementSibling).nodeName&&"A"!=n.nodeName||(n.style.display=e,t++);if(this.conditionAnimate&&this.conditionAnimate.right>0)for(var i=0,o=this;i<=this.conditionAnimate.right;)"SPAN"!=(o=o.nextElementSibling).nodeName&&"A"!=o.nodeName||(o.style.display=e,i++)},conditionRules:function(){let e=document.querySelectorAll(".condition-container>input, .condition-container>select");if(e.length>0&&this.conditionRulesSet.length>0)for(let t=0;t<e.length;t++){let n=e[t];if(n.id)for(let e=0;e<this.conditionRulesSet.length;e++){let t=this.conditionRulesSet[e];if(n.nodeName==t.type&&-1!=n.id.indexOf(t.code)){n.conditionAnimate=t,n.addEventListener("change",this.setVisibleTree),this.setVisibleTree.call(n);break}}}},updateEventListener:function(){let e=this.rootNode.querySelectorAll("select[id*=popupPropsCont__], input[id*=bonus_delay], select[id*=bonus_delay_type]");for(let t=0;t<e.length;t++)e[t].condMarker||(e[t].condMarker=!0,e[t].addEventListener("change",function(){manageCondTree.updateView()}))},updateColor:function(){let e=this.rootNode.querySelectorAll(".condition-container");for(let t=0;t<e.length;t++)for(let n=0;n<e[t].childNodes.length;n++){let i=e[t].childNodes[n];i.type&&"hidden"==i.type&&""!=i.value&&e[t].classList.add(i.value)}},updateHints:function(){let e=this.rootNode.querySelectorAll("input[type=hidden]");for(let t=0;t<e.length;t++)if(this.condDescriptions[e[t].value]){if(!e[t].parentElement.querySelector(".skwb24-item-hint")){let n=document.createElement("span");n.id="hint_condition_"+t,n.className="skwb24-item-hint",n.innerHTML="?",e[t].parentElement.insertBefore(n,e[t]),new top.BX.CHint({parent:n,show_timeout:10,hide_timeout:200,dx:2,preventHide:!0,min_width:400,hint:this.condDescriptions[e[t].value]})}}},updfatePeriodMarker:function(){let e=this.rootNode.querySelectorAll("select[id*=period]"),t=this.rootNode.querySelectorAll("input[id*=bonus_delay]"),n=this.rootNode.querySelectorAll("select[id*=bonus_delay_type]"),i=this.rootNode.querySelectorAll("select[id*=through_time]");for(let o=0;o<e.length;o++){let r=e[o].closest(".condition-container");if(r){let l=r.querySelector(".swPeriodSticker");l||((l=document.createElement("div")).className="swPeriodSticker",r.insertBefore(l,r.firstChild)),tmpBonusDelay=i[o]&&"N"==i[o].value?0:t[o].value;let a=this.prevRunPeriod(e[o].value,tmpBonusDelay,n[o].value);""!=a?l.innerHTML="<div><span>"+BX.message("periodLang")+"</span>: "+a+"<span> "+BX.message("periodLangOver")+"</span>: "+this.prevPeriod(e[o].value)+"</div>":BX.remove(l)}}},updateView:function(){this.updateEventListener(),this.updateColor(),this.updateHints(),this.updfatePeriodMarker(),this.conditionRules()},prevRunPeriod:function(e,t,n){if(t=parseInt(t),e){let i,o,r=this.prevPeriod(e).split(" - ");return r=(r=r[1]).split("."),r=new Date(r[2]+"-"+r[1]+"-"+r[0]),t>0&&("hour"==n?r.setHours(r.getHours()+t):"day"==n?r.setDate(r.getDate()+t):"week"==n?r.setDate(r.getDate()+7*t):"month"==n&&r.setMonth(r.getMonth()+t)),i=r.getDate(),o=r.getMonth()+1,(i=i>9?i:"0"+i)+"."+(o=o>9?o:"0"+o)+"."+r.getFullYear()}return""},prevPeriod:function(e){var t=new Date;if("month"==e){let e=new Date(t.getFullYear(),t.getMonth()+1,0),n=e.getMonth()+1;return n<10&&(n="0"+n),"01."+n+"."+e.getFullYear()+" - "+e.getDate()+"."+n+"."+e.getFullYear()}if("year"==e)return"01.01."+t.getFullYear()+" - 31.12."+t.getFullYear();if("quarter"==e)return t.getMonth()>8?"01.10."+(t.getFullYear()-1)+" - 31.12."+(t.getFullYear()-1):t.getMonth()>5?"01.07."+t.getFullYear()+" - 30.09."+t.getFullYear():t.getMonth()>2?"01.04."+t.getFullYear()+" - 30.06."+t.getFullYear():"01.01."+t.getFullYear()+" - 31.03."+t.getFullYear();if("week"==e){let e=t.getDay();e=0==e?0:7-e;let n=new Date(t.getFullYear(),t.getMonth(),t.getDate()+e),i=new Date(t.getFullYear(),t.getMonth(),t.getDate()+e-6),o=i.getMonth()+1,r=n.getMonth()+1;return o<10&&(o="0"+o),r<10&&(r="0"+r),i.getDate()+"."+o+"."+i.getFullYear()+" - "+n.getDate()+"."+r+"."+n.getFullYear()}}};BX.ready(function(){loyaltyTools.setHint();let e=BX("popupPropsCont");e&&manageCondTree.init({rootNode:e,showControls:showControls})});